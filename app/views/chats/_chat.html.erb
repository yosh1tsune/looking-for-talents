<div id="chat" class="chat_window justify-content-between">
  <div class="message_header">
    <span style="margin: 0; line-height:35px;"><%= @destinatary.full_name %></span>
    <button type="button" class="btn btn-outline-light" title="Fechar" onClick="$('#chat').remove()">
      <i class="fas fa-close" aria-hidden="true"></i>
    </button>
  </div>
  <div class="messages_list">
    <% @chat.messages.map do |message| %>
      <div id="messages" class="row <%= message.from == current_user ? 'message_sent' : 'message_received' %>">
        <p style="line-break: anywhere"><%= message.text %></p>
        <p class="message_timestamp" ><%= message.created_at.strftime('%H:%M') %></p>
      </div>
    <% end %>
  </div>
  <div>
    <%= form_for @chat.messages.new, remote: true, html: { class: 'form-inline' } do |form| %>
      <%= form.hidden_field :destinatary_id, value: @destinatary.id %>
      <%= form.hidden_field :destinatary_class, value: @destinatary.class %>
      <%= form.text_field :text, style: 'width: 86%', class: 'form-control', placeholder: 'Digite uma mensagem...', required: true %>
      <%= button_tag type: 'submit', id: 'message_send', style: 'width: 14%', class: "btn btn-outline-light", title: 'Enviar Mensagem' do %>
        <i class="fas fa-paper-plane" aria-hidden="true"></i>
      <% end %>
    <% end %>
  </div>
</div>

<script>
    App.cable.subscriptions.create({
      channel: "ChatChannel",
      id: <%= @chat.id %>
    },
    {
      connected() {
        console.log(this)
      },
      received(data) {
        if(data['from_type'] == '<%= current_user.class %>' && data['from_id'] == <%= current_user.id %>){
          return
        }

        $("#chat .messages_list").append(`
          <div id="messages" class="row message_received">
            <p style="line-break: anywhere">${data['text']}</p>
            <p class="message_timestamp" >${new Date(data['created_at']).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
          </div>
        `);
      }
    });
</script>
